file(GLOB ProtoFiles "${CMAKE_CURRENT_SOURCE_DIR}/*.proto")
PROTOBUF_GENERATE_CPP (ProtoSources_ ProtoHeaders ${ProtoFiles})
add_library(protocols STATIC ${ProtoSources_})
target_link_libraries(protocols ${PROTOBUF_LIBRARY})
set(ProtoIncludeDir ${CMAKE_CURRENT_BINARY_DIR}
    CACHE INTERNAL "Files generated by protobuf")

FUNCTION (GENERATE_PROTO_C ProtoFile SRC HDR)
    add_custom_command(OUTPUT ${SRC} ${HDR}
        PRE_BUILD
        COMMAND "protoc-c"
        ARGS -I${CMAKE_CURRENT_SOURCE_DIR} ${ProtoFile} --c_out=${CMAKE_CURRENT_BINARY_DIR}
        COMMENT "Running C protocol buffer compiler on ${ProtoFile}"
        VERBATIM)
ENDFUNCTION (GENERATE_PROTO_C)

FUNCTION (PROTOBUF_GENERATE_C SRC HDR)
    set(srcLoc "")
    set(hdrLoc "")
    foreach (f ${ARGN})
        get_filename_component(tmpFn ${f} NAME_WE)
        GENERATE_PROTO_C (${f} "${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.c" "${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.h")
        set_source_files_properties("${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.c" "${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.h" PROPERTIES GENERATED TRUE)
        LIST(APPEND srcLoc "${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.c")
        LIST(APPEND hdrLoc "${CMAKE_CURRENT_BINARY_DIR}/${tmpFn}.pb-c.h")
    ENDFOREACH(f)
    set(${SRC} "${srcLoc}" PARENT_SCOPE)
    set(${HDR} "${hdrLoc}" PARENT_SCOPE)
ENDFUNCTION (PROTOBUF_GENERATE_C)

PROTOBUF_GENERATE_C (ProtoSrcC ProtoHdrC ${ProtoFiles})

add_library(cprotocols STATIC ${ProtoSrcC})
target_link_libraries(cprotocols protobuf-c)